<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bocaditos</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css" />
  <script src="js/app.js" defer></script>
</head>
<body>
  <div class="page-wrap">
    <div class="panel">
      <div class="panel-inner">
        <aside class="usuario">
          <h2>Nombre de usuario</h2>
          <img src="assets/piña.png" alt="Avatar" class="avatar" />
          <div style="text-align:center">
            <span class="estado activo">Activo</span>
            <span class="estado baja">Baja</span>
          </div>
          <div class="profile-box">
            <p><strong>Rol de usuario:</strong> Beneficiario</p>
            <p><strong>Carrera:</strong> Lic. en patitos</p>
            <hr />
            <p><strong>Matrícula:</strong> 1234 56789</p>
            <p><strong>Grupo:</strong> Plaza Sésamo</p>
            <p><strong>Cuatrimestre:</strong> XOXOXOXOXO</p>
          </div>
          <button class="cerrar">Cerrar sesión</button>
        </aside>

        <main class="formulario">
          <div class="panel-title">Panel</div>
          <div class="chip">Bienvenida</div>

          <div class="card">
            <div class="card-inner">
              <div class="card-row">
                <img src="assets/alergia.jpg" alt="ilustracion" class="card-thumb">
                <div class="card-text">
                  <h3>¿Alergia alimentaria?</h3>
                  <p class="muted">Indique si es alérgico a algún tipo de comida.</p>
                  <div class="input-like">Ej: Nueces, mariscos, fresas...</div>
                </div>
                <button class="guardar">Guardar</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-inner">
              <div class="card-row">
                <img src="assets/buzon.png" alt="mail" class="card-thumb">
                <div class="card-text">
                  <h3>¿Comentarios o quejas?</h3>
                  <p class="muted">Comparte tus comentarios o quejas para mejorar nuestro servicio.</p>
                  <div class="input-like">Escriba aquí sus comentarios</div>
                </div>
                <button class="enviar">Enviar</button>
              </div>
            </div>
          </div>

        </main>
      </div>
    </div>
  </div>
</div>

  <script>
    // Verificación de sesión: redirige al login si no hay token o token inválido
    (async function(){
      try {
        var token = localStorage.getItem('bocaditos_token');
        var userStr = localStorage.getItem('bocaditos_user');
        if (!token || !userStr) {
          window.location.href = 'login.html';
          return;
        }
        var user = JSON.parse(userStr);
        // Verificar token llamando al endpoint /me (más eficiente)
        var res = await fetch('http://localhost:3000/me', {
          method: 'GET',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) {
          // token inválido o expirado
          localStorage.removeItem('bocaditos_token');
          localStorage.removeItem('bocaditos_user');
          window.location.href = 'login.html';
          return;
        }
        var fresh = await res.json();
        // Actualizar nombre mostrado si existe un elemento correspondiente
        var nameEls = document.querySelectorAll('.usuario h2');
        if (nameEls && nameEls.length) {
          nameEls.forEach(function(el){ el.textContent = fresh.name || (fresh.email || 'Usuario'); });
        }
      } catch (err) {
        console.error('Session check failed', err);
        localStorage.removeItem('bocaditos_token');
        localStorage.removeItem('bocaditos_user');
        window.location.href = 'login.html';
      }
    })();
  </script>
</body>
</html>
