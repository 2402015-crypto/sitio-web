<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Login Bocaditos</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="centered-page">
    <div class="form-wrap">
      <div class="avatar"><img src="assets/gato.png" alt="avatar"></div>
      <h2>LOGIN</h2>
      <form id="loginForm">
        <input class="input" name="email" type="email" placeholder="EMAIL ID" required>
        <input class="input" name="password" type="password" placeholder="PASSWORD" required>
        <label class="remember"><input type="checkbox"> REMEMBER ME</label>
        <div class="submit-row"><button class="btn" type="submit">LOG IN</button></div>
        <a class="forgot" href="#">Reset your password</a>
          <div class="signup-options" style="margin-top:18px;">
          <a class="signup-large" href="signup-students.html">Sign in for beneficiary</a>
          <a class="signup-large" href="signup-donors.html">Sign in for donors</a>
        </div>
      </form>
    </div>
  </div>
  <script>
    (function(){
      var form = document.getElementById('loginForm');
      if (!form) return;
      form.addEventListener('submit', async function(e){
        e.preventDefault();
        var fd = new FormData(form);
        var email = fd.get('email');
        var password = fd.get('password');

        try {
          var resp = await fetch('http://localhost:3000/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, password: password })
          });

          if (!resp.ok) {
            var err = await resp.json().catch(()=>({ error: 'Invalid credentials' }));
            alert(err.error || 'Error al iniciar sesión');
            return;
          }

          var data = await resp.json();
          // backend devuelve { user: {...}, token: '...' }
          if (data.token) {
            localStorage.setItem('bocaditos_token', data.token);
          }
          if (data.user) {
            localStorage.setItem('bocaditos_user', JSON.stringify(data.user));
          }

          // Intentar sincronizar alergias guardadas en localStorage con el servidor
          (function trySyncAllergiesAndComments(){
            // Helper: redirect to index
            function doRedirect(){ window.location.href = 'index.html'; }

            // Sync allergies first (if any), then comments
            try {
              var storedA = JSON.parse(localStorage.getItem('bocaditos_alergias') || '[]');
            } catch(e) { var storedA = []; }

            var allergyPayload = (storedA || []).map(function(s){ return (s && s.value) ? s.value : (typeof s === 'string' ? s : null); }).filter(Boolean);

            function syncCommentsThenRedirect(){
              try {
                var storedC = JSON.parse(localStorage.getItem('bocaditos_comentarios') || '[]');
              } catch(e) { var storedC = []; }
              var comments = (storedC || []).map(function(c){ return (c && c.text) ? c.text : (typeof c === 'string' ? c : null); }).filter(Boolean);
              if (!comments.length) { doRedirect(); return; }

              // send each comment to backend (sequentially or in parallel)
              var tokenHeader = 'Bearer ' + (data.token || '');
              var reqs = comments.map(function(txt){
                return fetch('http://localhost:3000/me/comments', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'Authorization': tokenHeader },
                  body: JSON.stringify({ comment: txt })
                }).then(function(res){ if (!res.ok) return res.json().then(function(j){ throw j; }); return res.json(); });
              });

              Promise.all(reqs).then(function(){
                try { localStorage.removeItem('bocaditos_comentarios'); } catch(e){}
                doRedirect();
              }).catch(function(err){
                console.warn('Comments sync failed, keeping local copy', err);
                doRedirect();
              });
            }

            if (!allergyPayload.length) {
              // No allergies to sync, continue to comments
              syncCommentsThenRedirect();
              return;
            }

            // POST allergies batch
            fetch('http://localhost:3000/me/allergies', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + (data.token || '') },
              body: JSON.stringify({ allergies: allergyPayload })
            }).then(function(res){
              if (!res.ok) return res.json().then(function(j){ throw j; });
              return res.json();
            }).then(function(result){
              try { localStorage.removeItem('bocaditos_alergias'); } catch(e){}
              // then sync comments
              syncCommentsThenRedirect();
            }).catch(function(err){
              console.warn('Allergy sync failed, keeping local copy', err);
              // still try to sync comments even if allergies failed
              syncCommentsThenRedirect();
            });
          })();
        } catch (err) {
          console.error('Login network error', err);
          alert('No se pudo conectar al servidor');
        }
      });
      // Agregar handlers para las opciones de signup dentro del formulario
      var signupBtns = document.querySelectorAll('.signup-large');
      signupBtns.forEach(function(btn){
        btn.addEventListener('click', function(ev){
          ev.preventDefault();
          var target = btn.getAttribute('href') || btn.dataset.target;
          if (target) {
            // navegación normal a la página correspondiente
            window.location.href = target;
          }
        });
      });
    })();
  </script>
</body>
</html>